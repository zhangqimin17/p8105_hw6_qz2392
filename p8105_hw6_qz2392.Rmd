---
title: "p8105_hw6_qz2392"
author: "Qimin Zhang"
date: "11/20/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(tidyselect)
```

# Problem 1

```{r message=FALSE, warning=FALSE}
birthweight = 
  read_csv("./birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace)
  )
```

```{r}
reg = lm(bwt ~ ., data = birthweight) %>%
  step(direction = "backward")

summary(reg)
```

```{r}
birthweight %>% 
  add_predictions(reg) %>% 
  add_residuals(reg) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point() +
  labs(
    titles = "Residuals VS fitted values"
  )
```

```{r}
lm(bwt ~ blength + gaweeks, data = birthweight) %>% 
 summary()
```

This model is with less variables and smaller adjusted R-squared, since it's a subset of my model, I can do ANOVA to test which is better.

```{r}
lm(bwt ~ blength + gaweeks, data = birthweight) %>% 
  anova(reg)
```

The p-value is very small, so we reject the null and conclude that my model (the one with more variables) is more superior than the model with only 'blength' and 'gaweeks' as variables.

```{r}
lm(bwt ~ bhead * blength * babysex, data = birthweight) %>% 
  summary()
```

This model had a smaller adjusted R-squared than mine but with statistically significant interaction term.

```{r}
cv_df = 
  crossv_mc(birthweight, 30) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
    )
```

```{r message=FALSE, warning=FALSE, include=FALSE}
cv_df = 
  cv_df %>% 
  mutate(reg1  = map(train, ~lm(bwt ~ ., data = .x) %>% step(direction = "backward")),
         reg2  = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         reg3  = map(train, ~lm(bwt ~ bhead * blength * babysex, data = .x))) %>% 
  mutate(rmse1 = map2_dbl(reg1, test, ~rmse(model = .x, data = .y)),
         rmse2 = map2_dbl(reg2, test, ~rmse(model = .x, data = .y)),
         rmse3 = map2_dbl(reg3, test, ~rmse(model = .x, data = .y)))
```

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```

According to the violin plot, my model, i.e., model 1 had the best performance.